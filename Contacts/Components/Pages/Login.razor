@page "/"
@layout Contacts.Components.Layout.LoginLayout
@using Microsoft.Data.SqlClient
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations

<h3>Login</h3>

<div class="LoginB">

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <p style="color:red">@errorMessage</p>
    }

    @if (!isLoggedIn)
    {

        <EditForm FormName="loginPage" Model=@loginModel OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <div class="Username">
                <label for="Username">Username:</label>
                <InputText @bind-Value="loginModel!.Username" class="form-control" id="Username"></InputText>
                <ValidationMessage For=@(() => loginModel.Username) />
            </div>
            <div>
                
                <label class="password" for="Password">Password:</label>
                <InputText @bind-Value="loginModel!.Password" class="form-control" id="Password"></InputText>
                <ValidationMessage For=@(() => loginModel.Password) />
            </div>

            <button class="form-group" type="submit">Login</button>

        </EditForm>

    }
    else
    {
        
        
    }

    @code {
        [SupplyParameterFromForm]
        private LoginModel loginModel { get; set; } = new();
        private bool shouldNavigate = false;
        private bool isLoggedIn = false;
        private string errorMessage = string.Empty;
        [Inject] NavigationManager NavManager { get; set; } = default!;
        [Inject] IConfiguration Configuration { get; set; } = default!;
        [Inject] Contacts.SqlConnectionService SqlService { get; set; } = default!;
        [Inject] ILogger<LoginModel> Logger { get; set; } = default!;
        protected override void OnInitialized() => loginModel ??= new();
        private void Submit() => Logger.LogInformation("Username = {Username}", loginModel?.Username, "Password={Password}", loginModel?.Password);


        private async Task HandleLogin()
        {
            var connStr = Configuration.GetConnectionString("DefaultConnection");
            int result = 0;
            bool dbError = false;

            try
            {
                using var conn = new SqlConnection(connStr);
                await conn.OpenAsync();

                using var cmd = new SqlCommand(@"
    SELECT COUNT(*) FROM Login
    WHERE RTRIM(LTRIM(UserName)) = @Username
    AND RTRIM(LTRIM(PassWord)) = @Password", conn);

                cmd.Parameters.AddWithValue("@Username", loginModel.Username.Trim());
                cmd.Parameters.AddWithValue("@Password", loginModel.Password.Trim());

                result = Convert.ToInt32(await cmd.ExecuteScalarAsync());
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Database login error.");
                errorMessage = "A database error occurred. Please try again later.";
                dbError = true;
            }

            if (dbError)
            {
                StateHasChanged(); // Show DB error message
                return;
            }

            if (result > 0)
            {
                isLoggedIn = true;
                errorMessage = "";
                StateHasChanged(); // Force UI update
                NavManager.NavigateTo("/Home", forceLoad: true);
            }
            else
            {
                errorMessage = "Invalid username or password.";
                StateHasChanged();
            }
        }

        
        
        

        public class LoginModel
        {
            public int Id { get; set; }
            [Required(ErrorMessage = "Username is required.")]
            public string Username { get; set; } = "";
			[Required(ErrorMessage = "Password is required.")]
            public string Password { get; set; } = "";


        }
        private List<MyDataModel>? data;

        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            var cmd = SqlService.CreateCommand("SELECT Id, UserName,PassWord FROM Login");
            using var reader = await cmd.ExecuteReaderAsync();
            data = new List<MyDataModel>();
            if (firstRender && isLoggedIn)
            {
                NavManager.NavigateTo("/Home", forceLoad: true);
            }
            await base.OnAfterRenderAsync(firstRender);
            while (await reader.ReadAsync())
            {
                data.Add(new MyDataModel
                {
                    Id = reader.GetInt32(0),
                    UserName = reader.GetString(1),
                    Password = reader.GetString(2)
                });
            }
        }

        class MyDataModel
        {
            public int Id { get; set; }
            [Required]
            public string UserName { get; set; } = "";
            [Required]
            public string Password { get; set; } = "";
        }
    }
</div>

